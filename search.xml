<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Java函数式编程之Optional</title>
      <link href="/2022/05/21/java-han-shu-shi-bian-cheng-zhi-optional/"/>
      <url>/2022/05/21/java-han-shu-shi-bian-cheng-zhi-optional/</url>
      
        <content type="html"><![CDATA[<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><blockquote><p>转载内容 如有侵权 或 不希望被转载 可以留言或私发告诉我，我会及时处理，尊重你的权利。<br>原文地址：<a href="https://juejin.cn/post/6844903908360323080">https://juejin.cn/post/6844903908360323080</a></p></blockquote><p><code>java.util.Optional</code>是JDK8中引入的类，它是JDK从著名的Java工具包<code>Guava</code>中移植过来。本文编写的时候使用的是JDK11。<code>Optional</code>是一个包含了<code>NULL</code>值或者非<code>NULL</code>值的对象容器，它常用作明确表明没有结果（其实明确表明存在结果也可以用<code>Optional</code>表示）的方法返回类型，这样可以避免<code>NULL</code>值带来的可能的异常（一般是<code>NullPointerException</code>）。也就是说，一个方法的返回值类型是<code>Optional</code>，则应该避免返回<code>NULL</code>，而应该让返回值指向一个包含<code>NULL</code>对象的<code>Optional</code>实例。<code>Optional</code>的出现为<code>NULL</code>判断、过滤操作、映射操作等提供了函数式适配入口，它算是Java引入函数式编程的一个重要的里程碑。</p><h2 id="Optional各个方法源码分析和使用场景"><a href="#Optional各个方法源码分析和使用场景" class="headerlink" title="Optional各个方法源码分析和使用场景"></a>Optional各个方法源码分析和使用场景</h2><p><code>Optional</code>的源码比较简单，归根于它是一个简单的对象容器。下面会结合源码分析它的所有构造、属性、方法和对应的使用场景。</p><h3 id="Optional属性和构造"><a href="#Optional属性和构造" class="headerlink" title="Optional属性和构造"></a>Optional属性和构造</h3><p><code>Optional</code>的属性和构造如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public final class Optional&lt;T&gt; &#123;    &#x2F;&#x2F; 这个是通用的代表NULL值的Optional实例    private static final Optional&lt;?&gt; EMPTY &#x3D; new Optional&lt;&gt;();    &#x2F;&#x2F; 泛型类型的对象实例    private final T value;        &#x2F;&#x2F; 实例化Optional，注意是私有修饰符，value置为NULL    private Optional() &#123;        this.value &#x3D; null;    &#125;        &#x2F;&#x2F; 直接返回内部的EMPTY实例    public static&lt;T&gt; Optional&lt;T&gt; empty() &#123;        @SuppressWarnings(&quot;unchecked&quot;)        Optional&lt;T&gt; t &#x3D; (Optional&lt;T&gt;) EMPTY;        return t;    &#125;        &#x2F;&#x2F; 通过value实例化Optional，如果value为NULL则抛出NPE    private Optional(T value) &#123;        this.value &#x3D; Objects.requireNonNull(value);    &#125;        &#x2F;&#x2F; 通过value实例化Optional，如果value为NULL则抛出NPE，实际上就是使用Optional(T value)    public static &lt;T&gt; Optional&lt;T&gt; of(T value) &#123;        return new Optional&lt;&gt;(value);    &#125;    &#x2F;&#x2F; 如果value为NULL则返回EMPTY实例，否则调用Optional#of(value)    public static &lt;T&gt; Optional&lt;T&gt; ofNullable(T value) &#123;        return value &#x3D;&#x3D; null ? empty() : of(value);    &#125;        &#x2F;&#x2F; 暂时省略其他代码&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果明确一个对象实例不为<code>NULL</code>的时候，应该使用<code>Optional#of()</code>，例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Order o &#x3D; selectByOrderId(orderId);assert null !&#x3D; oOptional op &#x3D; Optional.of(o);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果无法明确一个对象实例是否为<code>NULL</code>的时候，应该使用<code>Optional#ofNullable()</code>，例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Optional op &#x3D; Optional.ofNullable(selectByOrderId(orderId));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>明确表示一个持有<code>NULL</code>值的<code>Optional</code>实例可以使用<code>Optional.empty()</code>。</p><h3 id="get-方法"><a href="#get-方法" class="headerlink" title="get()方法"></a>get()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 如果value为空，则抛出NPE，否则直接返回valuepublic T get() &#123;    if (value &#x3D;&#x3D; null) &#123;        throw new NoSuchElementException(&quot;No value present&quot;);    &#125;    return value;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>get()</code>方法一般是需要明确<code>value</code>不为<code>NULL</code>的时候使用，它做了先验<code>value</code>的存在性。例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Order o &#x3D; selectByOrderId(orderId);assert null !&#x3D; oOptional op &#x3D; Optional.of(o);Order value &#x3D; op.get();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="isPresent-方法"><a href="#isPresent-方法" class="headerlink" title="isPresent()方法"></a>isPresent()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 判断value是否存在，不为NULL则返回true，如果为NULL则返回falsepublic boolean isPresent() &#123;    return value !&#x3D; null;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>举个例子：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Order o &#x3D; selectByOrderId(orderId);boolean existed &#x3D; Optional.ofNullable(o).isPresent();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="isEmpty-方法"><a href="#isEmpty-方法" class="headerlink" title="isEmpty()方法"></a>isEmpty()方法</h3><p><code>isEmpty()</code>是JDK11引入的方法，是<code>isPresent()</code>的反向判断：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 判断value是否存在，为NULL则返回true，为非NULL则返回falsepublic boolean isEmpty() &#123;    return value &#x3D;&#x3D; null;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ifPresent-方法"><a href="#ifPresent-方法" class="headerlink" title="ifPresent()方法"></a>ifPresent()方法</h3><p><code>ifPresent()</code>方法的作用是：如果<code>value</code>不为<code>NULL</code>，则使用<code>value</code>调用消费者函数式接口的消费方法<code>Consumer#accept()</code>：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public void ifPresent(Consumer&lt;? super T&gt; action) &#123;    if (value !&#x3D; null) &#123;        action.accept(value);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Optional.ofNullable(selectByOrderId(orderId)).ifPresent(o-&gt; LOGGER.info(&quot;订单ID:&#123;&#125;&quot;,o.getOrderId());<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ifPresentOrElse-方法"><a href="#ifPresentOrElse-方法" class="headerlink" title="ifPresentOrElse()方法"></a>ifPresentOrElse()方法</h3><p><code>ifPresentOrElse()</code>方法是JDK9新增的方法，它是<code>ifPresent()</code>方法的加强版，如果<code>value</code>不为<code>NULL</code>，则使用<code>value</code>调用消费者函数式接口的消费方法<code>Consumer#accept()</code>，如果<code>value</code>为<code>NULL</code>则执行<code>Runnable#run()</code>：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public void ifPresentOrElse(Consumer&lt;? super T&gt; action, Runnable emptyAction) &#123;    if (value !&#x3D; null) &#123;        action.accept(value);    &#125; else &#123;        emptyAction.run();    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">String orderId &#x3D; &quot;xxxx&quot;; Optional.ofNullable(selectByOrderId(orderId)).ifPresentOrElse(o-&gt; LOGGER.info(&quot;订单ID:&#123;&#125;&quot;,o.getOrderId()), ()-&gt; LOGGER.info(&quot;订单&#123;&#125;不存在&quot;,o.getOrderId()));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="filter-方法"><a href="#filter-方法" class="headerlink" title="filter()方法"></a>filter()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">public Optional&lt;T&gt; filter(Predicate&lt;? super T&gt; predicate) &#123;    &#x2F;&#x2F; 判断predicate不能为NULL    Objects.requireNonNull(predicate);    &#x2F;&#x2F; value为NULL，说明是空实例，则直接返回自身    if (!isPresent()) &#123;        return this;    &#125; else &#123;        &#x2F;&#x2F; value不为NULL，则通过predicate判断，命中返回自身，不命中则返回空实例empty        return predicate.test(value) ? this : empty();    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个方法的功能是简单的过滤功能，容器持有对象<code>value</code>非<code>NULL</code>会做一次判断，决定返回自身实例还是<code>empty()</code>。例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Optional.ofNullable(selectByOrderId(orderId)).filter(o -&gt; o.getStatus() &#x3D;&#x3D; 1).ifPresent(o-&gt; LOGGER.info(&quot;订单&#123;&#125;的状态为1&quot;,o.getOrderId));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="map-方法"><a href="#map-方法" class="headerlink" title="map()方法"></a>map()方法</h3><p><code>map()</code>是简单的值映射操作：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public &lt;U&gt; Optional&lt;U&gt; map(Function&lt;? super T, ? extends U&gt; mapper) &#123;    &#x2F;&#x2F; 判断mapper不能为NULL    Objects.requireNonNull(mapper);    &#x2F;&#x2F; value为NULL，说明是空实例，则直接返回empty()    if (!isPresent()) &#123;        return empty();    &#125; else &#123;        &#x2F;&#x2F; value不为NULL，通过mapper转换类型，重新封装为可空的Optional实例        return Optional.ofNullable(mapper.apply(value));    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>API注释里面的一个例子：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">List&lt;URI&gt; uris &#x3D; ...;&#x2F;&#x2F; 找到URI列表中未处理的URI对应的路径Optional&lt;Path&gt; p &#x3D; uris.stream().filter(uri -&gt; !isProcessedYet(uri)).findFirst().map(Paths::get);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="flatMap-方法"><a href="#flatMap-方法" class="headerlink" title="flatMap()方法"></a>flatMap()方法</h3><p><code>flatMap()</code>方法也是一个映射操作，不过映射的<code>Optional</code>类型返回值直接由外部决定，不需要通过值重新封装为<code>Optional</code>实例：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">public &lt;U&gt; Optional&lt;U&gt; flatMap(Function&lt;? super T, ? extends Optional&lt;? extends U&gt;&gt; mapper) &#123;    &#x2F;&#x2F; mapper存在性判断    Objects.requireNonNull(mapper);    &#x2F;&#x2F; value为NULL，说明是空实例，则直接返回empty()    if (!isPresent()) &#123;        return empty();    &#125; else &#123;        &#x2F;&#x2F; value不为NULL，通过mapper转换，直接返回mapper的返回值，做一次空判断        @SuppressWarnings(&quot;unchecked&quot;)        Optional&lt;U&gt; r &#x3D; (Optional&lt;U&gt;) mapper.apply(value);        return Objects.requireNonNull(r);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">class OptionalOrderFactory&#123;    static Optional&lt;Order&gt; create(String id)&#123;        &#x2F;&#x2F;省略...    &#125;&#125;String orderId &#x3D; &quot;xxx&quot;;Optional&lt;Order&gt; op &#x3D;  Optional.of(orderId).flatMap(id -&gt; OptionalOrderFactory.create(id));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="or-方法"><a href="#or-方法" class="headerlink" title="or()方法"></a>or()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">public Optional&lt;T&gt; or(Supplier&lt;? extends Optional&lt;? extends T&gt;&gt; supplier) &#123;    &#x2F;&#x2F; supplier存在性判断    Objects.requireNonNull(supplier);    &#x2F;&#x2F; value不为NULL，则直接返回自身    if (isPresent()) &#123;        return this;    &#125; else &#123;        &#x2F;&#x2F; value为NULL，则返回supplier提供的Optional实例，做一次空判断        @SuppressWarnings(&quot;unchecked&quot;)        Optional&lt;T&gt; r &#x3D; (Optional&lt;T&gt;) supplier.get();        return Objects.requireNonNull(r);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Order a &#x3D; null;Order b &#x3D; select();&#x2F;&#x2F; 拿到的就是b订单实例包装的OptionalOptional&lt;Order&gt; op &#x3D; Optional.ofNullable(a).or(b);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="stream-方法"><a href="#stream-方法" class="headerlink" title="stream()方法"></a>stream()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 对value做NULL判断，转换为Stream类型public Stream&lt;T&gt; stream() &#123;    if (!isPresent()) &#123;        return Stream.empty();    &#125; else &#123;        return Stream.of(value);    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="orElse-方法"><a href="#orElse-方法" class="headerlink" title="orElse()方法"></a>orElse()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 值不为NULL则直接返回value，否则返回otherpublic T orElse(T other) &#123;    return value !&#x3D; null ? value : other;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>orElse()</code>就是常见的提供默认值兜底的方法，例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">String v1 &#x3D; null;String v2 &#x3D; &quot;default&quot;;&#x2F;&#x2F; 拿到的就是v2对应的&quot;default&quot;值String value &#x3D; Optional.ofNullable(v1).orElse(v2);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="orElseGet-方法"><a href="#orElseGet-方法" class="headerlink" title="orElseGet()方法"></a>orElseGet()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 值不为NULL则直接返回value，否则返回Supplier#get()public T orElseGet(Supplier&lt;? extends T&gt; supplier) &#123;    return value !&#x3D; null ? value : supplier.get();&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>orElseGet()</code>只是<code>orElse()</code>方法的升级版，例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">String v1 &#x3D; null;Supplier&lt;String&gt; v2 &#x3D; () -&gt; &quot;default&quot;;&#x2F;&#x2F; 拿到的就是v2对应的&quot;default&quot;值String value &#x3D; Optional.ofNullable(v1).orElseGet(v2);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="orElseThrow-方法"><a href="#orElseThrow-方法" class="headerlink" title="orElseThrow()方法"></a>orElseThrow()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 如果值为NULL，则抛出NoSuchElementException，否则直接返回valuepublic T orElseThrow() &#123;    if (value &#x3D;&#x3D; null) &#123;        throw new NoSuchElementException(&quot;No value present&quot;);    &#125;    return value;&#125;&#x2F;&#x2F; 如果值不为NULL，则直接返回value，否则返回Supplier#get()提供的异常实例public &lt;X extends Throwable&gt; T orElseThrow(Supplier&lt;? extends X&gt; exceptionSupplier) throws X &#123;    if (value !&#x3D; null) &#123;        return value;    &#125; else &#123;        throw exceptionSupplier.get();    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Optional.ofNullable(orderInfoVo.getAmount()).orElseThrow(()-&gt; new IllegalArgumentException(String.format(&quot;%s订单的amount不能为NULL&quot;,orderInfoVo.getOrderId())));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="equals-和hashCode-方法"><a href="#equals-和hashCode-方法" class="headerlink" title="equals()和hashCode()方法"></a>equals()和hashCode()方法</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">public boolean equals(Object obj) &#123;    if (this &#x3D;&#x3D; obj) &#123;        return true;    &#125;    if (!(obj instanceof Optional)) &#123;        return false;    &#125;    Optional&lt;?&gt; other &#x3D; (Optional&lt;?&gt;) obj;    return Objects.equals(value, other.value);&#125;public int hashCode() &#123;    return Objects.hashCode(value);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这两个方法都是比较<code>value</code>，说明了<code>Optional</code>实例如果使用于<code>HashMap</code>的KEY，只要<code>value</code>相同，对于<code>HashMap</code>就是同一个KEY。如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Map&lt;Optional,Boolean&gt; map &#x3D; new HashMap&lt;&gt;();Optional&lt;String&gt; op1 &#x3D; Optional.of(&quot;throwable&quot;);map.put(op1, true);Optional&lt;String&gt; op2 &#x3D; Optional.of(&quot;throwable&quot;);map.put(op2, false);&#x2F;&#x2F; 输出falseSystem.out.println(map.get(op1));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Optional实战"><a href="#Optional实战" class="headerlink" title="Optional实战"></a>Optional实战</h2><p>下面展示一下<code>Optional</code>的一些常见的使用场景。</p><h3 id="空判断"><a href="#空判断" class="headerlink" title="空判断"></a>空判断</h3><p>空判断主要是用于不知道当前对象是否为<code>NULL</code>的时候，需要设置对象的属性。不使用<code>Optional</code>时候的代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">if(null !&#x3D; order)&#123;    order.setAmount(orderInfoVo.getAmount());&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>使用<code>Optional</code>时候的代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Optional.ofNullable(order).ifPresent(o -&gt; o.setAmount(orderInfoVo.getAmount()));&#x2F;&#x2F; 如果判断空的对象是OrderInfoVo如下Order o &#x3D; select();OrderInfoVo vo &#x3D; ...Optional.ofNullable(vo).ifPresent(v -&gt; o.setAmount(v.getAmount()));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>Optional</code>实现空判断的好处是<strong>只有一个属性设值的时候可以压缩代码为一行</strong>，这样做的话，代码会相对简洁。</p><h3 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h3><p>在维护一些老旧的系统的时候，很多情况下外部的传参没有做空判断，因此需要写一些断言代码如：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">if (null &#x3D;&#x3D; orderInfoVo.getAmount())&#123;    throw new IllegalArgumentException(String.format(&quot;%s订单的amount不能为NULL&quot;,orderInfoVo.getOrderId()));&#125;if (StringUtils.isBlank(orderInfoVo.getAddress())&#123;    throw new IllegalArgumentException(String.format(&quot;%s订单的address不能为空&quot;,orderInfoVo.getOrderId()));&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>Optional</code>后的断言代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">Optional.ofNullable(orderInfoVo.getAmount()).orElseThrow(()-&gt; new IllegalArgumentException(String.format(&quot;%s订单的amount不能为NULL&quot;,orderInfoVo.getOrderId())));Optional.ofNullable(orderInfoVo.getAddress()).orElseThrow(()-&gt; new IllegalArgumentException(String.format(&quot;%s订单的address不能为空&quot;,orderInfoVo.getOrderId())));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="综合仿真案例"><a href="#综合仿真案例" class="headerlink" title="综合仿真案例"></a>综合仿真案例</h3><p>下面是一个仿真案例，模拟的步骤如下：</p><ul><li>给出客户ID列表查询客户列表。</li><li>基于存在的客户列表中的客户ID查询订单列表。</li><li>基于订单列表转换为订单DTO视图列表。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">@Datastatic class Customer &#123;    private Long id;&#125;@Datastatic class Order &#123;    private Long id;    private String orderId;    private Long customerId;&#125;@Datastatic class OrderDto &#123;    private String orderId;&#125;&#x2F;&#x2F; 模拟客户查询private static List&lt;Customer&gt; selectCustomers(List&lt;Long&gt; ids) &#123;    return null;&#125;&#x2F;&#x2F; 模拟订单查询private static List&lt;Order&gt; selectOrders(List&lt;Long&gt; customerIds) &#123;    return null;&#125;&#x2F;&#x2F; main方法public static void main(String[] args) throws Exception &#123;    List&lt;Long&gt; ids &#x3D; new ArrayList&lt;&gt;();    List&lt;OrderDto&gt; view &#x3D; Optional.ofNullable(selectCustomers(ids))            .filter(cs -&gt; !cs.isEmpty())            .map(cs -&gt; selectOrders(cs.stream().map(Customer::getId).collect(Collectors.toList())))            .map(orders -&gt; &#123;                List&lt;OrderDto&gt; dtoList &#x3D; new ArrayList&lt;&gt;();                orders.forEach(o -&gt; &#123;                    OrderDto dto &#x3D; new OrderDto();                    dto.setOrderId(o.getOrderId());                    dtoList.add(dto);                &#125;);                return dtoList;            &#125;).orElse(Collections.emptyList());&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>Optional</code>本质是一个对象容器，它的特征如下：</p><ol><li><code>Optional</code>作为一个容器承载对象，提供方法适配部分函数式接口，结合部分函数式接口提供方法实现<code>NULL</code>判断、过滤操作、安全取值、映射操作等等。</li><li><code>Optional</code>一般使用场景是用于方法返回值的包装，当然也可以作为临时变量从而享受函数式接口的便捷功能。</li><li><code>Optional</code>只是一个简化操作的工具，可以解决多层嵌套代码的节点空判断问题（例如简化箭头型代码）。</li><li><code>Optional</code>并非银弹。</li></ol><p>这里提到箭头型代码，下面尝试用常规方法和<code>Optional</code>分别解决：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; 假设VO有多个层级，每个层级都不知道父节点是否为NULL，如下&#x2F;&#x2F; - OrderInfoVo&#x2F;&#x2F;   - UserInfoVo&#x2F;&#x2F;     - AddressInfoVo&#x2F;&#x2F;        - address(属性)&#x2F;&#x2F; 假设我要为address属性赋值，那么就会产生箭头型代码。&#x2F;&#x2F; 常规方法String address &#x3D; &quot;xxx&quot;;OrderInfoVo o &#x3D; ...;if(null !&#x3D; o)&#123;    UserInfoVo uiv &#x3D; o.getUserInfoVo();    if (null !&#x3D; uiv)&#123;        AddressInfoVo aiv &#x3D; uiv.getAddressInfoVo();        if (null !&#x3D; aiv)&#123;            aiv.setAddress(address);        &#125;    &#125;&#125;&#x2F;&#x2F; 使用OptionalString address &#x3D; &quot;xxx&quot;;OrderInfoVo o &#x3D; null;Optional.ofNullable(o)        .map(OrderInfoVo::getUserInfoVo)        .map(UserInfoVo::getAddressInfoVo)        .ifPresent(a -&gt; a.setAddress(address));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>Optional</code>解决箭头型代码，通过映射操作<code>map()</code>能减少大量的<code>if</code>和<code>NULL</code>判断分支，使得代码更加简洁。</p><p>有些开发者提议把<code>DAO</code>方法的返回值类型定义为<code>Optional</code>，笔者对此持中立态度，原因是：</p><ol><li><code>Optional</code>是JDK1.8引入，低版本的JDK并不能使用，不是所有的系统都能平滑迁移到JDK1.8+。</li><li>并不是所有人都热衷于函数式编程，因为它带来了便捷的同时转变了代码的阅读逻辑（有些人甚至会认为降低了代码的可读性）。</li></ol>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> Optional </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>球机PTZ和视场角与ONVIF和PTZ对应关系</title>
      <link href="/2022/05/21/qiu-ji-ptz-he-shi-chang-jiao-yu-onvif-he-ptz-dui-ying-guan-xi/"/>
      <url>/2022/05/21/qiu-ji-ptz-he-shi-chang-jiao-yu-onvif-he-ptz-dui-ying-guan-xi/</url>
      
        <content type="html"><![CDATA[<p>文章目录</p><h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><ul><li><p>不同品牌对应关系不一致，同一品牌，根据摄像头产品参数也会不一致</p></li><li><p>球机的PTZ和ONVIF的PTZ是线性关系</p></li><li><p>摄像头的视场角与ONVIF的Zoom是非线性关系</p></li><li><p>ONVIF的PTZ范围</p><p>P、T ∈[-1, 1]</p><p>Z∈ [0,1]</p></li><li><p>球机PTZ范围：根据不同型号不一致</p><h2 id="PTZ-ONVIF-amp-PTZ-SDK"><a href="#PTZ-ONVIF-amp-PTZ-SDK" class="headerlink" title="PTZ_ONVIF &amp; PTZ_SDK"></a>PTZ_ONVIF &amp; PTZ_SDK</h2></li><li><p>以海康相机iDS-2VS435-F837为例，分别ONVIF控制球机转动指定PTZ坐标，再使用SDK获取PTZ坐标</p></li><li>海康球机SDK获取PTZ坐标(具体参考《设备网络SDK使用手册》)</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">int p_pos &#x3D; HexToDecMa(ptz_pos.wPanPos) &#x2F; 10 % 360;&#x2F;&#x2F; 十六进制转化为十进制角度int t_pos &#x3D; HexToDecMa(ptz_pos.wTiltPos) &#x2F; 10 % 360;int z_pos &#x3D; HexToDecMa(ptz_pos.wZoomPos) &#x2F; 10 % 360;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ONVIF——&gt;PTZ</p><p>模型函数是线性关系$\ y=kx+b $<br>LS最小二乘拟合<br>关系如下：<br>\begin{cases}<br>p′=179.87∗p+179.95 \\<br>t′=55.00∗t+35.24 \\<br>z′=36.00∗z+1.0<br>\end{cases}</p><p>球机水平方向转动360°<br>球机垂直方向转动[-20°, 90°]<br>球机光学放大倍数37倍<br>可以根据参数来验证拟合关系，设计正交试验，只需要测量几次即可</p><p>球机视场角与ONVIF对应关系</p><p>有时候需要实时获取视场角</p><p>视场角∝放大倍数∝Zoom</p><p>以海康相机iDS-2VS435-F837为例，固定PT，分别ONVIF控制球机转动指定Z，再获取视场角，视场角获取可以参考《视场角计算》</p><p>对应关系如下：</p><p>ONVIF-Zoom ——&gt;水平/垂直视场角</p><p>可以很明显看出是非线性关系<br>采用《非线性优化算法——LM》拟合曲线<br>关系如下</p><script type="math/tex; mode=display">{ F O V H = 1.626 ∗ e 0.634 0.177 + z o o m F O V V = 0.953 ∗ e 0.598 0.166 + z o o m{FOVH=1.626∗e0.6340.177+zoomFOVV=0.953∗e0.5980.166+zoom{FOVH=1.626∗e0.6340.177+zoomFOVV=0.953∗e0.5980.166+zoom{ FOV H =1.626∗e 0.177+zoom0.634FOV V =0.953∗e 0.166+zoom0.598</script><p>​    </p><p>拟合效果如下</p>]]></content>
      
      
      
        <tags>
            
            <tag> camera,onvif </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/05/19/hello-world/"/>
      <url>/2022/05/19/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">public void main()&#123;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new &quot;My New Post&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
