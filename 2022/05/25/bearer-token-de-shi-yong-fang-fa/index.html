<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Bearer Token 的使用方法, Kevin Blog"><meta name="description" content="
转载内容 如有侵权 或 不希望被转载 可以留言或私发告诉我，我会及时处理，尊重你的权利。原文地址[https://blog.yorkxin.org/posts/oauth2-6-bearer-token.html]

這篇不屬於 OAut"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="referrer" content="no-referrer-when-downgrade"><title>Bearer Token 的使用方法 | Kevin Blog</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><script src="/libs/jquery/jquery-3.6.0.min.js"></script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Kevin Blog" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">Kevin Blog</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fas fa-list" style="zoom:.6"></i> <span>Medias</span> <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/musics"><i class="fas fa-music" style="margin-top:-20px;zoom:.6"></i> <span>Musics</span></a></li><li><a href="/movies"><i class="fas fa-film" style="margin-top:-20px;zoom:.6"></i> <span>Movies</span></a></li><li><a href="/books"><i class="fas fa-book" style="margin-top:-20px;zoom:.6"></i> <span>Books</span></a></li><li><a href="/galleries"><i class="fas fa-image" style="margin-top:-20px;zoom:.6"></i> <span>Galleries</span></a></li></ul></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">Kevin Blog</div><div class="logo-desc">All problems in computer science can be solved by another level of indirection.</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-list"></i> Medias <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/musics" style="margin-left:75px"><i class="fa fas fa-music" style="position:absolute;left:50px"></i> <span>Musics</span></a></li><li><a href="/movies" style="margin-left:75px"><i class="fa fas fa-film" style="position:absolute;left:50px"></i> <span>Movies</span></a></li><li><a href="/books" style="margin-left:75px"><i class="fa fas fa-book" style="position:absolute;left:50px"></i> <span>Books</span></a></li><li><a href="/galleries" style="margin-left:75px"><i class="fa fas fa-image" style="position:absolute;left:50px"></i> <span>Galleries</span></a></li></ul></li><li><div class="divider"></div></li><li><a href="https://github.com/swx11" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/swx11" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/21.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Bearer Token 的使用方法</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><span class="chip bg-color">无标签</span></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/OAuth/" class="post-category">OAuth</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2022-05-25</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 4k</div></div></div><hr class="clearfix"><link rel="stylesheet" href="/libs/prism/prism.css"><div class="card-content article-card-content"><div id="articleContent"><blockquote><p>转载内容 如有侵权 或 不希望被转载 可以留言或私发告诉我，我会及时处理，尊重你的权利。<br>原文地址[<a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/oauth2-6-bearer-token.html">https://blog.yorkxin.org/posts/oauth2-6-bearer-token.html</a>]</p></blockquote><p>這篇不屬於 OAuth 2.0 規格書（RFC 6749）本身，而是屬於另一份 spec <em><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6750">RFC 6750: The OAuth 2.0 Authorization Framework: Bearer Token Usage</a></em> 。我認為它存在的目的是「示範一下 Token 的用法，並且定義下來，讓大家可以參考」，因為 OAuth 2.0 規格書沒有明確規定「Token 長什麼樣子」，甚至「Resource Server 如何拒絕非法的 Token」（指 API）都沒定義，只規定了怎麼拿取、怎麼撤銷、怎麼流通。</p><p>實際上，即使有定義這個 Bearer Token ，各大網站的 API 也並非都使用這種 Token ，我看到有明確說明使用 Bearer Token 的像是 Twitter API，其他的要不是非使用 “Bearer” 關鍵字，就是沒有明確指出何種 Token （其實也不需要，因為在那些網站 Token 只有一種用途）。</p><p>不過即使如此，對於我打算實作的 API ，我也是準備使用 Bearer Token 的，因為夠 naïve 。如果你跟我一樣沒有自己刻 Token 的能力，就用 Bearer Token 就好了。</p><p>當然， RFC 6750 我也有轉成 <a target="_blank" rel="noopener" href="https://gist.github.com/yorkxin/6591290">Markdown 好讀版</a>。</p><h2 id="Bearer-Token-的用途"><a href="#Bearer-Token-的用途" class="headerlink" title="Bearer Token 的用途"></a>Bearer Token 的用途</h2><p>OAuth 2.0 (<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">RFC 6749</a>) 定義了 Client 如何取得 Access Token 的方法。Client 可以用 Access Token 以 Resource Owner 的名義來向 Resource Server 取得 Protected Resource ，例如我 (Resource Owner) 授權一個手機 App (Client) 以我 (Resource Owner) 的名義去 Facebook (Resource Server) 取得我的朋友名單 (Protected Resource)。OAuth 2.0 定義 Access Token 是 Resource Server 用來認證的唯一方式，有了這個， Resource Server 就不需要再提供其他認證方式，例如帳號密碼。</p><p>然而在 RFC 6749 裡面只定義抽象的概念，細節如 Access Token 格式、怎麼傳到 Resource Server ，以及 Access Token 無效時， Resource Server 怎麼處理，都沒有定義。所以在 RFC 6750 另外定義了 Bearer Token 的用法。Bearer Token 是一種 Access Token ，由 Authorization Server 在 Resource Owner 的允許下核發給 Client ，Resource Server 只要認這個 Token 就可以認定 Client 已經經由 Resource Owner 的許可，不需要用密碼學的方式來驗證這個 Token 的真偽。關於 Token 被偷走的安全性問題，此 Spec 裡面也有提到。</p><p><em>本段參考 Abstract 及 Section 1</em></p><h2 id="Bearer-Token-的格式"><a href="#Bearer-Token-的格式" class="headerlink" title="Bearer Token 的格式"></a>Bearer Token 的格式</h2><pre class="line-numbers language-none"><code class="language-none">Bearer XXXXXXXX<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中 <code>XXXXXXXX</code> 的格式為 b64token ，ABNF 的定義：</p><pre class="line-numbers language-none"><code class="language-none">b64token &#x3D; 1*( ALPHA &#x2F; DIGIT &#x2F; &quot;-&quot; &#x2F; &quot;.&quot; &#x2F; &quot;_&quot; &#x2F; &quot;~&quot; &#x2F; &quot;+&quot; &#x2F; &quot;&#x2F;&quot; ) *&quot;&#x3D;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>寫成 Regular Expression 即是：</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;[A-Za-z0-9\-\._~\+\&#x2F;]+&#x3D;*&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><em>本段參考 Section 2.1</em></p><h2 id="Client-向-Resource-Server-出示-Access-Token-的方式"><a href="#Client-向-Resource-Server-出示-Access-Token-的方式" class="headerlink" title="Client 向 Resource Server 出示 Access Token 的方式"></a>Client 向 Resource Server 出示 Access Token 的方式</h2><p>三種</p><h3 id="1-放在-HTTP-Header-裡面"><a href="#1-放在-HTTP-Header-裡面" class="headerlink" title="(1) 放在 HTTP Header 裡面"></a>(1) 放在 HTTP Header 裡面</h3><pre class="line-numbers language-none"><code class="language-none">GET &#x2F;resource HTTP&#x2F;1.1
Host: server.example.com
Authorization: Bearer mF_9.B5f-4.1JqM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Resource Server 必須支援這個方式。</p><p><em>本段參考 Section 2.2</em></p><h3 id="2-放在-Request-Body-裡面（Form-之類的）"><a href="#2-放在-Request-Body-裡面（Form-之類的）" class="headerlink" title="(2) 放在 Request Body 裡面（Form 之類的）"></a>(2) 放在 Request Body 裡面（Form 之類的）</h3><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;resource HTTP&#x2F;1.1
Host: server.example.com
Content-Type: application&#x2F;x-www-form-urlencoded

access_token&#x3D;mF_9.B5f-4.1JqM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>前提：</p><ul><li>Header 要有 <code>Content-Type: application/x-www-form-urlencoded</code>。</li><li>Body 格式要符合 <a target="_blank" rel="noopener" href="https://www.w3.org/TR/1999/REC-html401-19991224/interact/forms.html#h-17.13.4.1">W3C HTML 4.01 定義 application/x-www-form-urlencoded</a>。</li><li>Body 要只有一個 part （不可以是 multipart）。</li><li>Body 要編碼成只有 ASCII chars 的內容。</li><li>Request method 必須是一種有使用 request-body 的，也就是說不能用 <code>GET</code> 。</li></ul><p>就是送表單嘛，但不可以是 <code>multipart/form-data</code> 這種（通常用來上傳檔案）。</p><p>Resource Server 可以但不一定要支援這個方式。</p><p><em>本段參考 Section 2.3</em></p><h3 id="3-放在-URI-裡面的一個-Query-Parameter-（不建議）"><a href="#3-放在-URI-裡面的一個-Query-Parameter-（不建議）" class="headerlink" title="(3) 放在 URI 裡面的一個 Query Parameter （不建議）"></a>(3) 放在 URI 裡面的一個 Query Parameter （不建議）</h3><p>規定要使用 <code>access_token</code> 這個 parameter ，例：</p><pre class="line-numbers language-none"><code class="language-none">GET &#x2F;resource?access_token&#x3D;mF_9.B5f-4.1JqM HTTP&#x2F;1.1
Host: server.example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然而因為 URL 可以被 proxy 抄走（如 log）或存在瀏覽器的歷史記錄裡面，為了防 replay ，最好這樣做：</p><ul><li>Client 送 <code>Cache-Control: no-store</code> header</li><li>Server 回 <code>2xx</code> 的時候，送 <code>Cache-Control: private</code> header</li></ul><p><strong>Spec 不建議使用這種方法</strong>，如果真的沒辦法送 header 也沒辦法透過 request-body 送，再來考慮這種。</p><p>Resource Server 可以但不一定要支援這個方式。</p><p><em>本段參考 Section 2.4</em></p><h2 id="Resource-Server-向-Client-提示「認證不過，拒絕存取」的方式"><a href="#Resource-Server-向-Client-提示「認證不過，拒絕存取」的方式" class="headerlink" title="Resource Server 向 Client 提示「認證不過，拒絕存取」的方式"></a>Resource Server 向 Client 提示「認證不過，拒絕存取」的方式</h2><p>拒絕存取的情況，例如沒給 Access Token 或是給了但不合法（如空號、過期、Resource Owner 沒許可 Client 拿取此資料），則 Resource Server 必須在回應裡包含 <code>WWW-Authenticate</code> 的 header 來提示錯誤。這個 header 定義在 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2617#section-3.2.1">RFC 2617 Section 3.2.1</a>。<code>WWW-Authenticate</code> 的值，使用的 auth-scheme 是 <code>Bearer</code> ，隨後一個空格，接著要有至少一個 auth-param 。</p><p>範例：</p><pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 401 Unauthorized
WWW-Authenticate: Bearer realm&#x3D;&quot;example&quot;,
                  error&#x3D;&quot;invalid_token&quot;,
                  error_description&#x3D;&quot;The access token expired&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>以下這些 auth-params 是 <code>WWW-Authenticate</code> 會用到的：</p><div class="table-container"><table><thead><tr><th>參數名</th><th>必/選</th><th>填什麼/意義</th></tr></thead><tbody><tr><td>realm</td><td>選用</td><td>見下文</td></tr><tr><td>scope</td><td>選用</td><td>提示所需權限，見下文</td></tr><tr><td>error</td><td>選用</td><td>有出示 Access Token 則最好有這個</td></tr></tbody></table></div><h3 id="realm"><a href="#realm" class="headerlink" title="realm"></a><code>realm</code></h3><p>用 <code>realm</code> 來指出需要授權才能存取的範圍，意義跟 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2617">HTTP Authentication</a> 的 <code>realm</code> 一樣。<code>realm</code> 只能出現一次。</p><h3 id="scope"><a href="#scope" class="headerlink" title="scope"></a><code>scope</code></h3><p>用 <code>scope</code> 來指出「要拿這個 Resource 需要出示具有哪些 scope 的 Access Token 」：</p><ul><li>要區分大小寫。</li><li>要以空白分隔。</li><li>可以用哪些 scope ，是看 Authorization Server 怎麼定義，Spec 不定義，也沒有登錄中心。</li><li>順序不重要。</li><li>是給程式看的，不是設計給使用者看的。</li></ul><p><code>scope</code> 還可以在向 Authorization Server 索取新 Access Token 的時候使用。</p><p><code>scope</code> 值只能出現一次。實際寫在 <code>scope</code> 裡面的單一個 scope 必須只能用以下的字元，定義在 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749#appendix-A.4">RFC 6749 附錄 A.4</a> ：</p><pre class="line-numbers language-none"><code class="language-none">\x21, \x23-\x5b, \x5d-\x7e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>即可見的 US-ASCII 字元裡面，除了雙引號 <code>&quot;</code> (\x22) 和反斜線 <code>\</code> (\x5c) 以外。空格當然也不能用，因為是用來區分不同 scopes 的。</p><h3 id="error"><a href="#error" class="headerlink" title="error"></a><code>error</code></h3><p>如果 Client 出示了 Access Token 但認證失敗，則最好加上 <code>error</code> 這個 auth-param ，用來告訴 Client 為何認證失敗。此外還可以加上 <code>error_description</code> 用自然語言來告訴開發者為什麼錯誤，但這個不該給使用者看到。此外也可以加上 <code>error_uri</code> 用來提供一個網址，裡面用自然語言解釋錯誤訊息。這三個 auth-param 都只能最多出現一次。</p><p>如果 request 沒有出示 Access Token （例如 Client 不知道需要認證，或是使用了不支援的認證方式（例如不支援 URI parameter）），則 response 不應該帶 <code>error</code> 或任何錯誤訊息。</p><p><code>error</code> 的值的意義以及推薦使用的 HTTP response code 如下：</p><div class="table-container"><table><thead><tr><th>值</th><th>Status Code</th><th>意義/用途</th></tr></thead><tbody><tr><td>invalid_request</td><td>400 Bad Request</td><td>沒提供必要的參數、提供了不支援的參數、提供了錯誤的參數值、同樣的參數出現多次、使用一種以上的方法來出示 Access Token （如放在 header 裡又放在 form 裡）、或是其他無法解讀 request 的情況。</td></tr><tr><td>invalid_token</td><td>401 Unauthorized</td><td>Access Token 過期、被收回授權、無法解讀、或其他 Access Token 不合法的情況。這種情況下， Client 可以重新申請一個 Access Token 並且用新的 Access Token 來重試 request 。</td></tr><tr><td>insufficient_scope</td><td>403 Forbidden</td><td>這個 request 需要出示比 Client 出示的 Access Token 代表的 scopes 還要更多的 scopes 。這種情況下，可以另外提供 <code>scope</code> auth-param 來具體指出需要哪些 scopes 。</td></tr></tbody></table></div><p><code>error</code> 和 <code>error_description</code> 的值必須只能用以下的字元，定義在 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749#appendix-A.7">RFC 6749 附錄 A.7</a> 和 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749#appendix-A.8">RFC 6749 附錄 A.8</a>：</p><pre class="line-numbers language-none"><code class="language-none">\x20-\x21, \x23-\x5b, \x5d-\x7e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>即空格 (\x20) 再加上可見的 US-ASCII 字元裡面，除了雙引號 <code>&quot;</code> (\x22) 和反斜線 <code>\</code> (\x5c) 以外。</p><p><code>error_uri</code> 的值必須符合 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3986">RFC 3986</a> 的定義，即是只能用以下的字元（同 <code>scope</code> 裡面的單一 scope）：</p><pre class="line-numbers language-none"><code class="language-none">\x21, \x23-\x5b, \x5d-\x7e<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>即可見的 US-ASCII 字元裡面，除了雙引號 <code>&quot;</code> (\x22) 和反斜線 <code>\</code> (\x5c) 以外。</p><p><em>本段參考 Section 3 及 Section 3.1</em></p><h2 id="Authorization-Server-給-Client-核發-Access-Token-的範例"><a href="#Authorization-Server-給-Client-核發-Access-Token-的範例" class="headerlink" title="Authorization Server 給 Client 核發 Access Token 的範例"></a>Authorization Server 給 Client 核發 Access Token 的範例</h2><p>既然是 OAuth 2.0 的 access token ，就通常是循 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">OAuth 2.0 的 spec</a> 來核發，範例如下：</p><pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 OK
Content-Type: application&#x2F;json;charset&#x3D;UTF-8
Cache-Control: no-store
Pragma: no-cache

&#123;
  &quot;access_token&quot;:&quot;mF_9.B5f-4.1JqM&quot;,
  &quot;token_type&quot;:&quot;Bearer&quot;,
  &quot;expires_in&quot;:3600,
  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em>本段參考 Section 4</em></p><h2 id="安全性問題與對策"><a href="#安全性問題與對策" class="headerlink" title="安全性問題與對策"></a>安全性問題與對策</h2><p>RFC 6750 是基於 OAuth 2.0 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">RFC 6749</a> 來寫的，所以在該 spec 裡面提過的安全性問題就不再提及。</p><p>原文將問題與問題對策分開成 Section 5.1 和 Section 5.2 ，我為了方便筆記，所以合併在一起。以下「壞人」的原文是 <em>attacker</em>。</p><h3 id="一般對策"><a href="#一般對策" class="headerlink" title="一般對策"></a>一般對策</h3><p>大部份的安全性問題可以透過數位簽章或是 MAC (Message Authentication Code) 來防護。</p><p>Authorization Server 必須有實作 TLS，版本則隨時間推移而不同。 spec 作成的時候， TLS 最新版是 1.2 ，但實務上很少使用，1.0 才是最為廣泛利用的。</p><h3 id="偽造或竄改-Access-Token-的問題"><a href="#偽造或竄改-Access-Token-的問題" class="headerlink" title="偽造或竄改 Access Token 的問題"></a>偽造或竄改 Access Token 的問題</h3><p>壞人可能會偽造或竄改既有的 Access Token （竄改指的是修改授權範圍或授權參數），讓 Resource Server 給予 Client 不適當的存取權。例如，壞人可能會延長 Token 的過期時間。或是惡意的 Client 變造聲明來看到它不應該看到的東西，例如，告訴使用者只拿取公開的個人資料，卻在取得授權時，另外拿了朋友名單。</p><p><em>Section 5.1 &gt; Token manufacture/modification</em></p><h4 id="對策"><a href="#對策" class="headerlink" title="對策"></a>對策</h4><p>對於 Bearer Token ，可以只加一個參照用的 id 來間接指到真正的授權資訊，而不是直接燒在 Token 裡面。這種間接參照用的 id ，必須要難以被猜到；但使用間接參照，因為要間接檢查授權資訊，所以可能會導致 Resource Server 和 Authorization Server 之間有額外的動作※。這種機制的細節，spec 裡面沒有定義。</p><p>Spec 沒有定義 token 的編碼方式，所以不提及保護 Token 的完整性 (integrity) 的詳細建議。若要實作保護完整性的措施，則該實作方式必須要可以防止 Token 被竄改。</p><p>※：原文是 <em>“between a server and the token issuer”</em></p><h3 id="Access-Token-傳輸過程外洩、曝露敏感資料的問題"><a href="#Access-Token-傳輸過程外洩、曝露敏感資料的問題" class="headerlink" title="Access Token 傳輸過程外洩、曝露敏感資料的問題"></a>Access Token 傳輸過程外洩、曝露敏感資料的問題</h3><p>Token 傳輸過程可能被監聽而外洩，或 Token 本身可能會包含敏感資料※。</p><p>※在 Section 5.1 原文提及 “token disclosure” 的時候，僅提及曝露敏感資料，沒提及傳輸過程的外洩，然而 5.2 裡面關於 “token disclosure” 的對策，有一併提及傳輸過程外洩（中間人攻擊、監聽等），所以我寫這一段時，同時提及傳輸外洩以及曝露敏感資料。</p><p><em>Section 5.1 &gt; Token disclosure</em></p><h4 id="對策-1"><a href="#對策-1" class="headerlink" title="對策"></a>對策</h4><p>為了防範 Token 在傳輸過程外洩，必須用 TLS 來實作機密防護，且該實作方式必須要使用有提供機密防護和完整性防護的加密方式，如此就能要求 Client 與 Authorization Server 和 Client 與 Resource Server 之間的通訊要有機密防護和完整性防護。因為 TLS 是這份 spec 裡面規定一定要實作的，所以利用 TLS 來達成通訊過程的機密防護和完整性防護，是比較偏好的做法。</p><p>如果要防止 Client 取得 Token 的內容，那麼除了 TLS 之外，還必須實作 Token 加密。</p><p>要進一步防範 Token 外洩，則 Client 在發 request 的時候，還必須要驗證 TLS 的憑證鏈 (certificate chain) ，包括檢查憑證有沒有被撤銷（Certificate Revocation List, RFC 5280）。</p><p>Cookie 通常是明文傳輸的 (in the clear)，所以任何寫在裡面的資訊都有外洩的風險。所以， Bearer Token 絕對不可以存放在明文傳輸 cookie 裡面。詳見 RFC 6265 (HTTP State Management Mechanism) 裡面關於 cookie 的安全性問題。</p><p>某些部署方式，好比說利用 Load Balancer 的，TLS 傳輸在抵達 Resource Server 之前就結束了。這樣子會導致 Token 在前端 Load Balaner 和後端實體 Resrouce Server 之間，沒有加密保護。這種情況下，必須實作足夠的手段※，來確保前端和後端 server 之間的資料保密。Token 加密也是一種方式。</p><p>※ 原文為 <em>sufficient measures</em>，我不會翻譯…</p><h3 id="挪用-Access-Token-的問題"><a href="#挪用-Access-Token-的問題" class="headerlink" title="挪用 Access Token 的問題"></a>挪用 Access Token 的問題</h3><p>壞人可能會把某個專門給 Resource Server A 的 Access Token ，挪用到 Resource Server B ，使得 B 誤信該 Access Token 可以拿來存取 B 的資料。</p><p><em>Section 5.1 &gt; Token redirect</em></p><h4 id="對策-2"><a href="#對策-2" class="headerlink" title="對策"></a>對策</h4><p>要防止 Token 被挪用，則這件事很重要：Authorization Server 核發的 Token 裡面要附上被核發人的資訊（通常是一或多部 Resource Server）。同時，也建議限制 Token 可以使用的 scope 範圍。</p><h3 id="二度利用-Access-Token-的問題"><a href="#二度利用-Access-Token-的問題" class="headerlink" title="二度利用 Access Token 的問題"></a>二度利用 Access Token 的問題</h3><p>壞人使用之前就存在的 Access Token 來存取 Reseouce Server （即：Token 被偷去用）。</p><p><em>Section 5.1 &gt; Token replay</em></p><h3 id="對策-3"><a href="#對策-3" class="headerlink" title="對策"></a>對策</h3><p>要防止 Token 被偷走並且拿來二度利用，建議採用以下方案：</p><ol><li>Token 的存活時間必須被限制住。一種手段是在 Token 受保護的區段裡面，設一個合法期間。使用短時效的 Token （如一小時以下）可以降低 Token 外洩的風險。</li></ol><ul><li>Token 在 Client ↔ Authorization Server 、 Client ↔ Resource Server 之間交換的時候，必須要實作機密防護。如此一來，就算在傳輸途徑上監聽，也無法獲得 Token ，也就無法二度利用。</li><li>Client 要向 Resource Server 出示 Token 的時候，Client 必須驗證 Resource Server 的真實身份，如 RFC 2818 (TLS) 的 Section 3.1 裡面所述。注意，Client 必須要驗證 TLS 憑證的憑證鏈 (certificate chain)。若 Resource Server 未經授權且未通過認證，或是憑證鏈驗證失敗，這時候向它出示 Token ，會導致敵手取得 Token 並且得到未經授權的權限來存取受保護的 resource。</li></ul><h2 id="安全性建議的總結"><a href="#安全性建議的總結" class="headerlink" title="安全性建議的總結"></a>安全性建議的總結</h2><p><em>Section 5.3 Summary of Recommendations</em></p><h3 id="要藏好-Bearer-Token"><a href="#要藏好-Bearer-Token" class="headerlink" title="要藏好 Bearer Token"></a>要藏好 Bearer Token</h3><p>Client 實作必須確保 Bearer Token 不會外洩給無關人士，因為他們可以以此來存取受保護的 resources。利用 Bearer Token 時，這是首要的安全性考量，且優先於其他更細節的建議。</p><h3 id="要驗證-TLS-的憑證鏈"><a href="#要驗證-TLS-的憑證鏈" class="headerlink" title="要驗證 TLS 的憑證鏈"></a>要驗證 TLS 的憑證鏈</h3><p>當 Client 發 request 索取受保護的 resources 的時候，Client 必須驗證 TLS 的憑證鏈。若做不到的話，可能會引發 DNS 劫持，導致 Token 被壞人偷走。</p><h3 id="全程使用-TLS-https"><a href="#全程使用-TLS-https" class="headerlink" title="全程使用 TLS (https)"></a>全程使用 TLS (https)</h3><p>當 Clients 利用 Bearer Token 發 request 時，Client 必須一直使用 TLS (RFC5246) (https) 或同等的安全傳輸。若做不到的話， Token 會曝露在各種攻擊方式，讓壞人可以得到意料之外的存取權。</p><h3 id="不要把-Bearer-Token-存在-Cookie"><a href="#不要把-Bearer-Token-存在-Cookie" class="headerlink" title="不要把 Bearer Token 存在 Cookie"></a>不要把 Bearer Token 存在 Cookie</h3><p>絕對不可以把 Bearer Token 存在可以明文傳輸 (sent in the clear) 的 Cookie 裡面（明文傳輸是 cookie 傳輸的預設方式）。若存在 Cookie 裡面，必須要小心 Cross-Site Request Forgery 。</p><h3 id="要核發短時效的-Bearer-Token"><a href="#要核發短時效的-Bearer-Token" class="headerlink" title="要核發短時效的 Bearer Token"></a>要核發短時效的 Bearer Token</h3><p>核發 Token 的伺服器最好是核發短時效的 Bearer Token （一小時以內），尤其是發給跑在瀏覽器裡面的 Client ，或是其他容易發生資訊外洩的場合。利用短時效的 Bearer Token 可以降低 Token 外洩時的衝擊。</p><h3 id="要核發有區分使用範圍的-Bearer-Token"><a href="#要核發有區分使用範圍的-Bearer-Token" class="headerlink" title="要核發有區分使用範圍的 Bearer Token"></a>要核發有區分使用範圍的 Bearer Token</h3><p>Token 伺服器最好要核發包含 audience restriction, scoping their use to the intended replying party, or set of relying party 的 Token 。</p><h3 id="不要用-Page-URL-來傳送-Bearer-Token"><a href="#不要用-Page-URL-來傳送-Bearer-Token" class="headerlink" title="不要用 Page URL 來傳送 Bearer Token"></a>不要用 Page URL 來傳送 Bearer Token</h3><p>Bearer Token 最好不要從 URL 來傳送（例如 query parameter），而最好是從有保密措施的 HTTP header 或是 body 來傳輸※。瀏覽器、伺服器等軟體可能不會把歷史記錄或資料結構給妥善加密。如果 Bearer Token 透過 URL 傳輸，則壞人就有可能可以從歷史記錄取得之。</p><p>※ <em>“be passed in HTTP message headers or message bodies for which confidentiality measures are taken”</em></p><hr><h2 id="OAuth-2-0-系列文目錄"><a href="#OAuth-2-0-系列文目錄" class="headerlink" title="OAuth 2.0 系列文目錄"></a>OAuth 2.0 系列文目錄</h2><ul><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-1-introduction/">(1) 世界觀</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-2-cilent-registration/">(2) Client 的註冊與認證</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-3-endpoints/">(3) Endpoints 的規格</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-4-1-auth-code-grant-flow/">(4.1) Authorization Code Grant Flow 細節</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-4-2-implicit-grant-flow/">(4.2) Implicit Grant Flow 細節</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-4-3-resource-owner-credentials-grant-flow/">(4.3) Resource Owner Credentials Grant Flow 細節</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-4-4-client-credentials-grant-flow/">(4.4) Client Credentials Grant Flow 細節</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-5-issuing-tokens/">(5) 核發與換發 Access Token</a></li><li><strong><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-6-bearer-token/">(6) Bearer Token 的使用方法</a> ← You Are Here</strong></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-7-security-considerations/">(7) 安全性問題</a></li><li><a target="_blank" rel="noopener" href="https://blog.yorkxin.org/posts/2013/09/30/oauth2-implementation-differences-among-famous-sites/">各大網站 OAuth 2.0 實作差異</a></li></ul></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">Kevin</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://knowledgeThing.github.io/2022/05/25/bearer-token-de-shi-yong-fang-fa/">https://knowledgeThing.github.io/2022/05/25/bearer-token-de-shi-yong-fang-fa/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">Kevin</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><span class="chip bg-color">无标签</span></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.mvaline-card{margin:1.5rem auto}.mvaline-card .card-content{padding:20px 20px 5px 20px}</style><div class="card mvaline-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="mvcomments" class="card-content" style="display:grid"></div></div><script src="/libs/minivaline/MiniValine.js"></script><script>new MiniValine(Object.assign({enable:!0,serverURL:"https://minivaline.your-domain.top"},{el:"#mvcomments"}))</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/2022/05/25/node-red-api-authentication/"><div class="card-image"><img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Node-RED api Authentication"> <span class="card-title">Node-RED api Authentication</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-05-25 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Node-RED/" class="post-category">Node-RED</a></span></div></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2022/05/25/markdown-yu-fa-su-cha-biao/"><div class="card-image"><img src="/medias/featureimages/15.jpg" class="responsive-img" alt="Markdown 语法速查表"> <span class="card-title">Markdown 语法速查表</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-05-25 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/markdown/" class="post-category">markdown</a></span></div></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if(void 0!==window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"!==n.getRangeAt(0).commonAncestorContainer.nodeName&&"CODE"!==n.getRangeAt(0).commonAncestorContainer.nodeName||(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: Kevin Blog<br />文章作者: Kevin<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2022</span> <a href="/about" target="_blank">Kevin</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="busuanzi_container_site_pv">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp; <span id="busuanzi_value_site_pv" class="white-color"></span> </span><span id="busuanzi_container_site_uv">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp; <span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t="2022",n=e.getFullYear(),i=e.getMonth()+1,a=e.getDate(),r=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),g=Date.UTC(t,"5","20","0","0","0"),d=Date.UTC(n,i,a,r,s,o)-g,m=Math.floor(d/31536e6),l=Math.floor(d/864e5-365*m);if(t===String(n)){document.getElementById("year").innerHTML=n;var c="This site has been running for "+l+" days";c="本站已运行 "+l+" 天",document.getElementById("sitetime").innerHTML=c}else{document.getElementById("year").innerHTML=t+" - "+n;var u="This site has been running for "+m+" years and "+l+" days";u="本站已运行 "+m+" 年 "+l+" 天",document.getElementById("sitetime").innerHTML=u}};calcSiteTime()</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/swx11" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:swx001pk@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=741131663" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 741131663" data-position="top" data-delay="50"><i class="fab fa-qq"></i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script src="/js/prism.js" async></script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script type="text/javascript">$(function(){!function(t,a,s){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),r=document.getElementById(a),n=document.getElementById(s);r.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var r=!0,n=t.title.trim().toLowerCase(),a=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),e=t.url;e=0===e.indexOf("/")?t.url:"/"+e;var s=-1,i=-1,l=-1;if(""!==n&&""!==a&&m.forEach(function(t,e){s=n.indexOf(t),i=a.indexOf(t),s<0&&i<0?r=!1:(i<0&&(i=0),0===e&&(l=i))}),r){f+="<li><a href='"+e+"' class='search-result-title'>"+n+"</a>";var c=t.content.trim().replace(/<[^>]+>/g,"");if(0<=l){var u=l-20,o=l+80;u<0&&(u=0),0===u&&(o=100),o>c.length&&(o=c.length);var h=c.substr(u,o);m.forEach(function(t){var e=new RegExp(t,"gi");h=h.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+h+"...</p>"}f+="</li>"}}),f+="</ul>",n.innerHTML=f)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script src="https://ssl.captcha.qq.com/TCaptcha.js"></script><script src="/libs/others/TencentCaptcha.js"></script><button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script></body></html>